<!DOCTYPE html>
<html>
<head>
    <title>Component Nesting Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: system-ui; margin: 20px; }
        .card { border: 1px solid #ccc; padding: 16px; margin: 8px 0; border-radius: 8px; }
        .card-header { font-weight: bold; margin-bottom: 8px; }
        .card-content { margin: 8px 0; }
        .skills-display .category { margin-bottom: 16px; }
        .skills-display h3 { margin: 0 0 8px 0; }
        .skills-display .skill-item { 
            background: #f5f5f5; 
            padding: 8px; 
            margin: 4px; 
            border-radius: 4px;
            display: inline-block;
        }
        .markdown h2 { margin-top: 0; }
        .markdown ul { margin: 8px 0; }
    </style>
</head>
<body>
    <h1>ðŸ”¥ Component Nesting Test</h1>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Mock components (simplified versions)
        function Card({ title, content, className = '' }) {
            return (
                <div className={`card ${className}`}>
                    {title && <div className="card-header">{title}</div>}
                    {content && <div className="card-content">{content}</div>}
                </div>
            );
        }

        function Markdown({ content }) {
            return (
                <div className="markdown" dangerouslySetInnerHTML={{
                    __html: content
                        .replace(/## (.*)/g, '<h2>$1</h2>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/- (.*)/g, '<li>$1</li>')
                        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                        .replace(/\n\n/g, '<br><br>')
                }} />
            );
        }

        function Skills({ categories }) {
            return (
                <div className="skills-display">
                    {categories.map((category, i) => (
                        <div key={i} className="category">
                            <h3>{category.name}</h3>
                            <div>
                                {category.skills.map((skill, j) => (
                                    <div key={j} className="skill-item">
                                        <div>{skill.name}</div>
                                        <div style={{fontSize: '12px', color: '#666'}}>{skill.level}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // Component registry
        const COMPONENTS = {
            card: Card,
            markdown: Markdown, 
            skills: Skills
        };

        // ðŸ”¥ THE NESTING IMPLEMENTATION
        function processData(data) {
            if (data && typeof data === 'object' && data.type) {
                return renderItem(data, 0); // Nested component
            }
            if (Array.isArray(data)) {
                return data.map((item, i) => processData(item)); // Nested arrays
            }
            return data; // Regular data passthrough
        }

        function renderItem(item, key) {
            const { type, data } = item;
            
            // Process all data props for nesting
            const processedData = Object.fromEntries(
                Object.entries(data).map(([k, v]) => [k, processData(v)])
            );
            
            const Component = COMPONENTS[type];
            return Component ? (
                React.createElement(Component, { key, ...processedData })
            ) : (
                React.createElement('div', { key }, `Unknown: ${type}`)
            );
        }

        function render(agentJSON) {
            const parsed = typeof agentJSON === 'string' ? JSON.parse(agentJSON) : agentJSON;
            
            if (Array.isArray(parsed)) {
                return React.createElement('div', { className: 'flex flex-col gap-4' }, 
                    parsed.map((item, i) => renderItem(item, i))
                );
            }
            
            return renderItem(parsed, 0);
        }

        // Test cases
        const testCases = [
            {
                name: "Simple Card with Nested Markdown",
                json: {
                    "type": "card",
                    "data": {
                        "title": "Rich Content Card", 
                        "content": {
                            "type": "markdown",
                            "data": {
                                "content": "## Nested Markdown\n\n- Point 1\n- Point 2\n\n**Bold text** inside nested component!"
                            }
                        }
                    }
                }
            },
            {
                name: "Card with Nested Skills",
                json: {
                    "type": "card",
                    "data": {
                        "title": "My Technical Stack",
                        "content": {
                            "type": "skills", 
                            "data": {
                                "categories": [
                                    {
                                        "name": "Languages",
                                        "skills": [
                                            {"name": "Python", "level": "Expert"},
                                            {"name": "TypeScript", "level": "Advanced"}
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                }
            }
        ];

        function App() {
            return (
                <div>
                    {testCases.map((testCase, i) => (
                        <div key={i} style={{marginBottom: '32px'}}>
                            <h2>ðŸ§ª {testCase.name}</h2>
                            {render(testCase.json)}
                        </div>
                    ))}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>